<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬”è®° - Chime Stone</title>
    <link rel="stylesheet" href="assets/css/main.css?v=2.0">
    <link rel="stylesheet" href="assets/css/notes.css?v=2.0">
    <link rel="icon" href="assets/img/avatar.jpg">
</head>
<body>
    <nav class="top-nav">
        <div class="nav-container">
            <a href="index.html" class="nav-link">é¦–é¡µ</a>
            <a href="notes.html" class="nav-link">ç¬”è®°</a>
            <a href="#" class="nav-link" onclick="event.preventDefault(); alert('å…³äºé¡µé¢å»ºè®¾ä¸­...');">å…³äº</a>
            <a href="https://github.com/chimestone/" class="nav-link" target="_blank">GitHub</a>
        </div>
    </nav>
    <header id="panel" class="panel-cover">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content">
                    <h1 class="panel-cover__title panel-title iUp">
                        <a href="#" title="æˆ‘çš„ç¬”è®°">æˆ‘çš„ç¬”è®°</a>
                    </h1>
                    <p class="panel-cover__subtitle panel-subtitle iUp">è®°å½•ç”Ÿæ´»çš„ç‚¹ç‚¹æ»´æ»´</p>
                    <hr class="panel-cover__divider iUp" />
                    
                    <div class="notes-actions iUp">
                        <p class="upload-instruction">è¦æ·»åŠ ç¬”è®°ï¼Œè¯·å°†Markdownæ–‡ä»¶ä¸Šä¼ åˆ° <code>notes/</code> æ–‡ä»¶å¤¹å¹¶pushåˆ°GitHub</p>
                    </div>

                    <div id="notes-list" class="notes-display iUp">
                        <p style="text-align: center; color: rgba(255,255,255,0.8);">æš‚æ— ç¬”è®°ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ç¯‡ç¬”è®°</p>
                    </div>
                </div>
            </div>
            <div class="panel-cover--overlay cover-slate"></div>
        </div>
        <div class="remark iUp">
            <p class="power">Powered By 
                <a href="https://github.com/features/actions" target="_blank"> GitHub Actions </a> And 
                <a href="https://hitokoto.cn/" target="_blank"> Hitokoto </a>
            </p>
        </div>
    </header>

    <script src="assets/js/main.js?v=2.0"></script>
    <script src="assets/json/images.json?cb=getBingImages"></script>
    <script>
        // ç¬”è®°ç®¡ç†åŠŸèƒ½
        let notes = [];
        
        // ä»GitHubè¯»å–ç¬”è®°åˆ—è¡¨ï¼ˆæ”¯æŒæ–‡ä»¶å¤¹ï¼‰
        async function loadNotesFromGitHub() {
            try {
                notes = [];
                await loadNotesRecursively('notes', '');
                renderStickyNotes();
            } catch (error) {
                console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
                document.getElementById('notes-list').innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.8);">åŠ è½½ç¬”è®°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
            }
        }
        
        // é€’å½’åŠ è½½æ–‡ä»¶å¤¹å†…å®¹
        async function loadNotesRecursively(path, folder) {
            const response = await fetch(`https://api.github.com/repos/chimestone/web/contents/${path}`);
            const items = await response.json();
            
            for (const item of items) {
                if (item.type === 'file' && item.name.endsWith('.md')) {
                    const content = await fetchMarkdownContent(item.download_url);
                    notes.push({
                        id: `${folder}${item.name}`.replace('.md', ''),
                        title: item.name.replace('.md', ''),
                        content: content,
                        filename: item.name,
                        folder: folder,
                        path: item.path
                    });
                } else if (item.type === 'dir') {
                    await loadNotesRecursively(item.path, item.name + '/');
                }
            }
        }
        
        // è·å–Markdownå†…å®¹
        async function fetchMarkdownContent(url) {
            const response = await fetch(url);
            return await response.text();
        }
        
        // æ¸²æŸ“ä¾¿åˆ©è´´ï¼ˆæ”¯æŒæ–‡ä»¶å¤¹åˆ†ç»„ï¼‰
        function renderStickyNotes() {
            const notesList = document.getElementById('notes-list');
            if (notes.length === 0) {
                notesList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.8);">æš‚æ— ç¬”è®°ï¼Œè¯·ä¸Šä¼ Markdownæ–‡ä»¶åˆ°notesæ–‡ä»¶å¤¹</p>';
                return;
            }
            
            // æŒ‰æ–‡ä»¶å¤¹åˆ†ç»„
            const groupedNotes = groupNotesByFolder();
            let html = '';
            
            Object.keys(groupedNotes).forEach((folder, folderIndex) => {
                const folderNotes = groupedNotes[folder];
                const folderColor = getFolderColor(folderIndex);
                
                if (folder) {
                    html += `<div class="folder-section" data-folder="${folder}">`;
                    html += `<h3 class="folder-title">ğŸ“ ${folder.replace('/', '')}</h3>`;
                } else {
                    html += `<div class="folder-section root-folder">`;
                }
                
                html += '<div class="notes-group">';
                
                folderNotes.forEach((note, noteIndex) => {
                    const h1s = extractH1s(note.content);
                    const hasPushpin = folder !== ''; // æ ¹ç›®å½•æ–‡ä»¶æ— å¤§å¤´é’ˆ
                    
                    html += `
                        <div class="sticky-note-container" data-folder="${folder}" data-note-index="${noteIndex}">
                            ${hasPushpin ? `<div class="pushpin" style="--pin-color: ${folderColor}"></div>` : ''}
                            <div class="sticky-note" onclick="openNoteDetail('${note.id}')">
                                <div class="note-title">${escapeHtml(note.title)}</div>
                                <div class="note-lines"></div>
                                <div class="note-h1">${escapeHtml(h1s)}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            notesList.innerHTML = html;
            
            // æ¸²æŸ“è¿æ¥çº¿
            setTimeout(() => drawConnectingLines(), 100);
        }
        
        // æŒ‰æ–‡ä»¶å¤¹åˆ†ç»„
        function groupNotesByFolder() {
            const grouped = {};
            notes.forEach(note => {
                const folder = note.folder || '';
                if (!grouped[folder]) {
                    grouped[folder] = [];
                }
                grouped[folder].push(note);
            });
            return grouped;
        }
        
        // è·å–æ–‡ä»¶å¤¹é¢œè‰²
        function getFolderColor(index) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            return colors[index % colors.length];
        }
        
        // ç»˜åˆ¶è¿æ¥çº¿
        function drawConnectingLines() {
            // æ¸…é™¤æ—§çš„è¿æ¥çº¿
            document.querySelectorAll('.connecting-line').forEach(line => line.remove());
            
            // ä¸ºæ¯ä¸ªæ–‡ä»¶å¤¹ç»˜åˆ¶è¿æ¥çº¿
            document.querySelectorAll('.folder-section').forEach(section => {
                const folder = section.dataset.folder;
                if (!folder) return; // è·³è¿‡æ ¹ç›®å½•
                
                const pushpins = section.querySelectorAll('.pushpin');
                if (pushpins.length < 2) return; // å°‘äº2ä¸ªä¸éœ€è¦è¿çº¿
                
                const folderIndex = Array.from(document.querySelectorAll('.folder-section')).indexOf(section);
                const color = getFolderColor(folderIndex);
                
                for (let i = 0; i < pushpins.length - 1; i++) {
                    drawLineBetweenPushpins(pushpins[i], pushpins[i + 1], color);
                }
            });
        }
        
        // åœ¨ä¸¤ä¸ªå¤§å¤´é’ˆä¹‹é—´ç»˜çº¿
        function drawLineBetweenPushpins(pin1, pin2, color) {
            const rect1 = pin1.getBoundingClientRect();
            const rect2 = pin2.getBoundingClientRect();
            const container = document.getElementById('notes-list');
            const containerRect = container.getBoundingClientRect();
            
            const x1 = rect1.left + rect1.width / 2 - containerRect.left;
            const y1 = rect1.top + rect1.height / 2 - containerRect.top;
            const x2 = rect2.left + rect2.width / 2 - containerRect.left;
            const y2 = rect2.top + rect2.height / 2 - containerRect.top;
            
            const line = document.createElement('div');
            line.className = 'connecting-line';
            line.style.cssText = `
                position: absolute;
                left: ${Math.min(x1, x2)}px;
                top: ${Math.min(y1, y2)}px;
                width: ${Math.abs(x2 - x1)}px;
                height: ${Math.abs(y2 - y1)}px;
                pointer-events: none;
                z-index: 1;
            `;
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.cssText = 'width: 100%; height: 100%;';
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const startX = x1 < x2 ? 0 : Math.abs(x2 - x1);
            const startY = y1 < y2 ? 0 : Math.abs(y2 - y1);
            const endX = x1 < x2 ? Math.abs(x2 - x1) : 0;
            const endY = y1 < y2 ? Math.abs(y2 - y1) : 0;
            
            path.setAttribute('d', `M ${startX} ${startY} L ${endX} ${endY}`);
            path.setAttribute('stroke', color);
            path.setAttribute('stroke-width', '2');
            path.setAttribute('stroke-dasharray', '5,5');
            
            svg.appendChild(path);
            line.appendChild(svg);
            container.appendChild(line);
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æå–markdownä¸­çš„å¤šä¸ªä¸€çº§æ ‡é¢˜ï¼Œæ™ºèƒ½æ§åˆ¶è¡Œæ•°
        function extractH1s(content) {
            const h1Matches = content.match(/^#\s+(.+)$/gm);
            if (!h1Matches) return 'æš‚æ— ä¸€çº§æ ‡é¢˜';
            
            const h1s = h1Matches.map(match => match.replace(/^#\s+/, ''));
            const maxLines = 5; // ä¾¿åˆ©è´´æœ€å¤šæ˜¾ç¤º5è¡Œ
            let result = [];
            let currentLines = 0;
            
            for (let i = 0; i < h1s.length; i++) {
                const title = h1s[i];
                // ä¼°ç®—æ ‡é¢˜å ç”¨çš„è¡Œæ•°ï¼ˆæ¯è¡Œçº¦15ä¸ªå­—ç¬¦ï¼‰
                const titleLines = Math.ceil(title.length / 15);
                
                if (currentLines + titleLines <= maxLines) {
                    result.push(title);
                    currentLines += titleLines;
                } else {
                    // å¦‚æœè¿˜æœ‰æ›´å¤šæ ‡é¢˜ï¼Œæ·»åŠ çœç•¥å·
                    if (i < h1s.length - 1 || currentLines + titleLines > maxLines) {
                        result.push('...');
                    }
                    break;
                }
            }
            
            return result.join('\n');
        }
        
        // æ‰“å¼€ç¬”è®°è¯¦æƒ…é¡µ
        function openNoteDetail(noteId) {
            console.log('Opening note:', noteId);
            window.location.href = `note-detail.html?id=${noteId}`;
        }
        

        

        
        // äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            // é¡µé¢åŠ è½½æ—¶ä» GitHub åŠ è½½ç¬”è®°
            loadNotesFromGitHub();
        });
        
        // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜è¿æ¥çº¿
        window.addEventListener('resize', () => {
            setTimeout(() => drawConnectingLines(), 100);
        });
    </script>
</body>
</html>